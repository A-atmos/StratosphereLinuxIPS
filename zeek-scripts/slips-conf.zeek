redef LogAscii::use_json=T;
# known-services will only consider local networks.
redef Site::local_nets += { 192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 };
# zeek needs to know where maxmind db is. mmdb_dir should now be slips/databases
redef mmdb_dir = fmt("%s%s", rstrip(@DIR, "zeek-scripts/."), "/databases");

export {

        ## DoH servers
        option port_inactivity_timeouts: table[port] of interval = {
                [[21/tcp, 22/tcp, 23/tcp, 513/tcp]] = 1 hrs,
        };
        global doh_servers: set[addr] = { 45.90.30.147, 45.90.30.123, 45.90.30.174, 217.160.249.29, 45.90.28.38, 45.90.28.25, 45.90.29.14, 75.2.80.144, 213.183.62.11, 89.233.43.71, 176.126.70.229, 31.216.6.41, 195.91.66.55, 176.58.92.236, 45.90.28.71, 45.90.30.10, 45.90.28.107, 45.90.30.12, 80.125.181.13, 86.0.64.55, 80.124.140.238, 107.162.133.99, 217.138.209.217, 74.82.42.42, 213.61.254.42, 45.90.29.12, 45.90.28.59, 116.202.244.138, 128.93.162.64, 64.64.248.141, 45.90.30.44, 45.90.30.221, 54.227.13.144, 92.63.170.105, 45.90.29.211, 45.90.28.242, 45.90.29.148, 45.90.29.129, 170.176.145.150, 140.238.174.12, 223.5.5.5, 217.146.11.49, 119.28.63.83, 45.90.29.44, 209.177.158.248, 46.101.66.244, 149.112.112.12, 104.225.11.36, 17.253.16.119, 45.90.30.81, 185.88.160.25, 165.232.130.184, 45.90.28.62, 45.90.30.91, 194.39.205.162, 188.172.213.149, 210.246.144.15, 51.79.173.140, 86.109.1.91, 47.254.160.160, 149.112.121.20, 45.90.28.95, 14.192.49.53, 178.18.54.141, 202.218.2.19, 31.187.64.235, 109.24.72.11, 37.252.239.39, 49.229.0.115, 47.103.18.1, 72.11.134.91, 80.125.181.186, 121.196.195.196, 93.115.24.204, 45.90.30.52, 45.90.30.120, 45.131.68.245, 47.100.218.41, 45.90.28.211, 175.24.154.191, 45.125.0.88, 45.90.28.68, 45.90.29.203, 185.210.2.70, 90.145.32.35, 91.212.238.22, 80.125.180.156, 45.90.28.237, 87.98.175.85, 52.48.147.197, 212.86.101.213, 45.90.30.232, 1.192.192.206, 45.77.137.133, 45.90.30.160, 45.90.30.132, 168.235.64.166, 78.47.105.4, 46.101.126.246, 45.90.29.15, 75.75.77.24, 88.215.65.27, 80.125.181.174, 45.90.29.204, 130.59.31.248, 95.216.161.62, 92.63.32.3, 17.253.24.85, 185.12.88.92, 45.90.30.239, 82.148.223.195, 34.73.73.224, 185.140.250.174, 108.40.78.219, 67.8.56.46, 45.90.29.13, 81.7.14.159, 80.125.181.185, 93.189.61.195, 158.101.195.71, 3.128.212.186, 80.125.181.116, 172.83.159.59, 140.238.228.220, 132.145.80.242, 45.90.29.233, 75.75.77.25, 45.90.28.152, 45.90.28.181, 45.90.29.79, 209.177.158.226, 45.90.30.92, 3.208.47.162, 8.8.4.4, 167.6.236.224, 5.188.168.252, 39.98.133.171, 45.90.28.160, 8.208.2.64, 17.253.22.247, 45.90.28.253, 124.70.72.126, 45.90.30.47, 204.15.75.156, 149.129.239.2, 45.90.29.114, 51.140.100.181, 45.90.28.207, 45.90.29.35, 130.89.162.82, 172.65.220.168, 202.232.2.33, 161.97.171.39, 23.209.73.136, 178.32.196.195, 54.189.234.230, 152.67.199.120, 17.253.30.85, 104.225.216.146, 80.125.180.155, 195.228.221.132, 185.247.117.121, 149.112.122.30, 168.138.250.131, 45.90.30.31, 199.38.182.187, 210.130.0.70, 45.90.28.222, 17.253.124.119, 45.90.30.158, 45.90.28.14, 81.7.14.52, 116.12.51.216, 18.210.8.52, 80.124.140.239, 44.233.140.212, 80.124.140.166, 91.212.238.14, 155.138.142.93, 217.146.31.87, 109.24.70.11, 217.0.43.66, 45.90.30.198, 80.254.79.157, 193.17.47.1, 194.191.40.98, 185.244.195.159, 45.90.30.253, 84.21.7.14, 45.90.30.157, 210.138.123.111, 210.130.1.3, 75.75.77.6, 52.44.142.142, 96.17.108.202, 199.38.182.12, 66.42.70.192, 45.90.30.222, 45.90.28.148, 209.208.110.56, 49.229.0.46, 196.20.72.29, 131.100.2.149, 217.31.204.205, 45.90.29.106, 109.24.70.70, 80.125.180.165, 199.38.181.200, 128.199.94.194, 45.90.30.190, 35.229.156.160, 45.90.30.96, 185.210.2.71, 91.230.211.67, 67.230.177.135, 203.204.102.17, 45.90.28.126, 217.146.107.8, 91.239.96.21, 116.204.183.61, 36.99.170.86, 45.32.47.13, 34.66.70.56, 45.90.30.146, 52.42.217.166, 81.7.14.215, 80.125.181.123, 54.72.41.135, 70.113.111.13, 23.100.95.102, 101.101.101.101, 180.163.249.75, 45.90.28.115, 45.90.29.248, 78.142.193.36, 45.90.28.8, 217.66.37.27, 82.118.227.235, 184.31.0.235, 128.139.197.53, 173.212.232.112, 205.147.105.156, 45.90.28.235, 173.199.126.35, 149.112.149.112, 194.62.167.148, 149.112.112.13, 216.119.155.49, 80.125.181.71, 80.251.225.218, 5.39.88.20, 47.103.166.51, 45.90.28.149, 140.82.59.231, 82.165.97.135, 45.90.28.141, 217.173.235.78, 193.190.198.16, 80.125.180.65, 213.61.254.39, 202.232.2.32, 139.199.33.37, 80.125.161.172, 80.125.180.95, 114.34.116.139, 52.43.41.34, 88.98.88.158, 149.154.157.148, 45.90.28.66, 80.125.161.67, 45.90.29.177, 45.90.28.172, 107.172.90.160, 17.253.12.247, 138.201.246.200, 45.90.29.181, 3.7.176.123, 192.73.240.126, 54.155.209.93, 140.238.3.36, 161.210.250.8, 45.90.28.24, 45.90.29.245, 203.180.146.24, 45.90.30.5, 185.43.135.1, 116.63.136.113, 45.90.29.131, 80.125.180.125, 17.253.26.85, 45.90.28.214, 45.90.30.166, 45.90.29.193, 45.90.29.209, 63.116.30.36, 45.90.29.90, 95.216.74.67, 45.90.29.67, 45.90.28.52, 109.2.202.236, 3.232.78.158, 194.191.40.100, 45.90.28.201, 45.90.28.2, 82.165.247.205, 87.106.168.61, 45.90.28.75, 45.90.29.179, 80.125.161.108, 45.90.30.99, 45.90.29.132, 45.90.28.223, 17.253.66.247, 45.90.28.82, 121.199.79.161, 111.206.170.220, 45.90.29.251, 47.108.0.45, 192.73.244.179, 80.125.161.105, 165.22.46.136, 45.90.30.84, 45.151.175.112, 45.90.30.161, 37.252.247.133, 45.90.28.206, 194.204.251.11, 45.90.28.150, 24.134.187.45, 45.90.29.116, 140.82.45.97, 45.90.28.167, 106.11.37.109, 80.251.195.73, 80.125.161.177, 217.160.25.182, 149.112.112.10, 45.90.29.118, 37.139.26.4, 45.90.29.123, 185.253.154.66, 185.40.106.78, 45.90.28.90, 180.163.223.236, 3.224.109.152, 45.131.68.246, 210.138.123.75, 45.90.28.88, 17.253.124.247, 35.229.69.83, 119.28.59.205, 37.235.49.73, 45.90.30.107, 207.154.225.150, 45.90.28.64, 193.106.119.10, 185.185.69.93, 45.90.28.118, 193.180.80.10, 94.16.114.254, 116.203.131.110, 45.90.29.212, 17.253.82.213, 23.94.120.177, 20.42.80.49, 45.90.29.229, 45.90.30.57, 107.182.22.203, 134.102.20.26, 200.25.57.69, 173.243.64.102, 185.233.104.206, 45.90.28.5, 106.14.221.10, 151.181.237.20, 80.125.181.124, 45.90.29.120, 45.90.28.236, 45.90.30.162, 104.225.8.147, 45.90.28.230, 52.55.49.18, 213.61.254.44, 75.75.77.5, 210.128.97.74, 109.24.72.14, 80.124.140.240, 193.190.182.53, 101.32.30.247, 157.245.36.211, 144.172.119.31, 45.90.30.83, 140.238.215.120, 223.5.5.109, 210.138.123.79, 176.58.90.11, 80.124.140.207, 80.124.140.131, 210.128.97.78, 136.244.79.94, 45.90.28.91, 188.34.186.98, 45.90.30.215, 210.130.0.51, 45.90.28.70, 37.120.149.148, 45.132.75.16, 45.90.28.45, 45.90.28.134, 3.9.78.39, 17.253.56.85, 185.244.27.53, 52.17.180.181, 109.24.70.47, 203.180.146.12, 195.238.187.150, 54.169.113.231, 168.119.160.80, 141.84.69.2, 45.90.28.203, 45.90.29.234, 47.108.0.58, 193.170.194.22, 45.90.30.238, 216.230.232.29, 213.139.211.36, 45.90.30.62, 45.90.28.78, 77.223.128.220, 80.125.181.99, 134.102.20.20, 101.198.198.198, 89.17.159.213, 45.90.30.65, 3.209.17.34, 119.3.218.92, 45.90.30.9, 217.160.44.149, 45.90.30.22, 31.216.14.42, 45.90.28.110, 80.124.140.201, 217.169.20.23, 8.129.77.255, 8.39.235.108, 45.90.28.13, 45.90.28.120, 45.90.29.93, 45.90.28.28, 104.225.11.172, 108.61.189.69, 95.216.187.185, 54.79.3.18, 85.145.222.167, 80.125.181.80, 45.90.28.170, 213.61.254.36, 54.171.175.41, 139.99.134.6, 45.90.29.17, 103.196.38.38, 80.124.140.160, 195.50.204.191, 45.90.30.18, 135.181.102.167, 82.64.163.190, 185.12.88.178, 52.41.109.236, 45.90.30.136, 45.90.28.80, 45.90.28.41, 142.93.33.36, 149.129.124.211, 80.125.180.100, 45.125.0.53, 45.90.30.250, 203.180.146.203, 45.90.28.154, 110.43.53.226, 17.253.6.85, 86.106.103.153, 17.253.38.243, 52.209.174.126, 210.138.123.76, 209.208.26.145, 45.90.29.36, 34.247.230.158, 5.1.32.33, 45.90.28.212, 45.90.28.49, 83.69.169.222, 103.6.212.123, 103.149.46.217, 212.227.205.78, 172.107.93.122, 91.212.238.8, 45.90.30.252, 45.90.28.239, 106.11.37.96, 206.189.185.210, 159.100.248.193, 104.225.11.245, 45.90.28.43, 104.198.99.225, 80.251.201.59, 155.138.148.63, 140.238.159.230, 92.223.65.71, 194.87.94.229, 104.225.12.146, 45.90.28.121, 45.90.29.75, 51.222.107.153, 203.162.172.59, 109.24.72.150, 44.234.219.208, 167.71.190.157, 5.34.180.247, 82.64.205.253, 52.34.132.225, 147.162.22.1, 80.124.140.200, 217.169.20.22, 45.90.28.220, 45.90.29.50, 9.9.9.9, 130.255.78.51, 217.0.43.2, 45.117.103.234, 45.90.30.170, 209.177.145.66, 52.18.44.241, 81.7.14.85, 210.138.123.74, 34.72.159.240, 203.180.146.208, 45.90.29.225, 210.138.123.109, 45.90.28.243, 208.111.39.77, 193.191.129.46, 94.130.182.199, 9.9.9.11, 35.211.162.236, 210.130.0.21, 222.88.72.38, 194.204.251.13, 45.90.28.101, 116.203.115.225, 195.228.221.3, 45.90.28.127, 210.138.123.105, 45.90.28.99, 80.125.180.73, 45.90.29.99, 45.90.29.197, 45.90.29.149, 45.90.28.117, 176.103.130.137, 80.125.161.117, 45.90.30.150, 193.9.112.136, 80.254.77.39, 167.179.64.116, 45.90.28.191, 5.79.100.76, 44.229.182.61, 45.90.29.47, 161.210.250.7, 45.90.29.174, 45.79.120.233, 18.216.182.207, 176.31.83.186, 188.241.178.104, 45.90.28.246, 45.90.28.93, 213.149.105.9, 45.90.30.77, 140.238.28.191, 45.90.28.9, 210.128.97.88, 45.90.29.188, 44.237.198.74, 194.249.0.142, 176.223.136.169, 47.244.3.29, 162.250.2.3, 64.20.34.50, 52.16.163.185, 54.172.110.180, 80.124.140.168, 45.90.28.67, 209.177.158.142, 95.216.209.165, 160.16.53.149, 161.210.250.2, 45.90.29.86, 109.27.84.62, 82.165.23.176, 66.42.50.16, 162.250.7.137, 81.7.14.83, 45.90.29.25, 209.177.158.15, 94.140.15.15, 138.197.159.48, 162.14.132.76, 93.115.24.205, 140.238.220.58, 222.124.173.197, 213.61.254.41, 80.124.140.157, 80.124.140.129, 198.23.209.146, 75.2.118.36, 45.90.30.177, 80.124.140.233, 17.253.82.247, 45.90.28.37, 45.90.29.141, 3.248.149.109, 109.24.70.2, 152.67.229.20, 45.90.28.12, 45.90.30.169, 80.125.181.183, 213.149.240.21, 45.77.229.157, 47.103.166.50, 34.96.142.40, 147.230.16.240, 45.90.28.164, 54.237.181.250, 119.147.179.244, 45.90.28.39, 72.44.68.88, 45.90.30.74, 39.100.20.1, 80.125.161.90, 149.28.161.146, 45.90.29.214, 185.26.125.181, 104.225.12.24, 194.191.40.97, 80.125.180.161, 37.252.254.39, 45.90.29.196, 80.125.180.124, 185.183.159.34, 45.90.28.57, 52.19.206.74, 45.90.29.103, 194.87.239.59, 45.90.29.119, 45.90.29.27, 161.97.79.138, 68.183.70.223, 52.215.49.128, 45.90.28.198, 159.69.108.26, 17.253.36.85, 45.90.30.129, 45.90.30.192, 221.181.72.233, 80.124.140.144, 213.183.62.162, 95.217.213.94, 45.77.162.235, 45.90.30.46, 35.223.113.18, 45.90.28.122, 168.235.81.167, 180.163.223.231, 45.90.29.23, 45.90.29.62, 45.90.28.232, 45.90.28.228, 45.32.219.28, 89.187.169.24, 104.225.11.199, 176.125.239.22, 34.197.6.94, 45.90.28.105, 54.73.239.183, 45.90.28.132, 45.90.28.96, 81.7.14.252, 152.89.161.16, 208.111.35.106, 134.209.81.226, 72.11.134.90, 45.90.29.142, 188.172.192.71, 45.90.30.226, 45.90.29.0, 45.90.30.19, 17.253.56.213, 45.90.30.109, 180.163.223.233, 47.108.0.39, 79.110.170.43, 45.90.29.33, 80.125.161.184, 158.101.2.228, 139.199.193.210, 91.191.170.21, 161.35.28.190, 45.90.28.79, 188.172.251.1, 45.90.29.217, 45.90.29.190, 45.90.30.6, 185.12.88.179, 45.90.30.138, 216.98.99.110, 210.128.97.85, 45.90.30.149, 45.90.30.195, 106.11.37.100, 5.59.130.114, 210.130.0.53, 139.59.223.113, 45.90.30.35, 116.203.30.98, 17.253.34.247, 39.103.26.198, 200.25.36.70, 217.146.1.31, 178.255.153.47, 45.90.29.171, 1.0.0.2, 210.128.97.83, 91.239.27.199, 34.101.84.129, 141.84.69.29, 80.124.140.163, 35.227.19.85, 52.31.171.166, 45.90.30.7, 93.180.70.22, 45.90.30.203, 17.253.82.119, 193.122.96.153, 210.128.97.215, 185.56.27.1, 176.103.130.136, 45.90.30.225, 80.125.181.98, 156.251.165.134, 45.90.29.85, 45.77.223.173, 45.90.30.245, 141.100.59.223, 203.180.146.13, 52.31.191.149, 17.253.2.247, 143.244.33.90, 130.61.93.4, 80.149.229.107, 45.90.30.0, 45.90.30.188, 45.90.29.100, 142.93.248.50, 45.90.28.226, 45.90.30.32, 192.73.240.168, 45.90.28.173, 45.90.28.36, 45.90.30.214, 212.26.128.3, 52.49.195.5, 130.61.69.193, 8.131.52.117, 51.81.224.232, 54.95.198.208, 185.229.226.28, 45.90.28.197, 210.128.97.217, 51.81.81.178, 80.125.181.179, 207.148.95.1, 47.103.166.56, 45.35.154.2, 45.90.28.103, 195.244.44.45, 17.253.24.213, 45.90.29.8, 45.90.28.84, 45.90.28.106, 91.217.86.4, 168.95.1.1, 101.198.199.200, 45.90.28.208, 45.90.30.3, 45.90.30.3, 45.90.29.128, 79.143.240.7, 80.125.161.86, 45.90.30.80, 45.90.28.199, 45.90.30.113, 45.90.28.249, 3.121.138.96, 45.90.29.223, 45.90.30.76, 45.90.29.16, 86.159.144.0, 45.90.28.76, 45.77.154.135, 17.253.12.215, 44.238.109.133, 104.225.11.200, 39.103.26.199, 103.123.164.2, 45.60.186.33, 45.90.30.78, 45.90.29.169, 140.207.198.6, 159.203.35.192, 116.202.103.81, 195.161.115.16, 154.121.2.53, 78.128.99.220, 103.196.38.40, 109.24.72.41, 17.253.84.247, 45.90.28.182, 74.63.24.248, 45.90.28.163, 107.20.123.160, 109.24.72.34, 170.39.227.247, 47.103.166.53, 45.90.28.166, 103.219.152.6, 80.124.140.221, 143.244.33.74, 185.150.10.229, 193.150.121.28, 45.90.30.191, 158.64.1.29, 124.70.83.172, 185.235.81.1, 45.90.30.124, 45.90.29.244, 45.90.30.197, 45.90.28.224, 86.73.221.179, 45.90.30.11, 81.7.14.191, 172.81.108.146, 176.58.88.213, 45.90.30.189, 9.9.9.10, 17.253.96.85, 37.252.225.79, 45.90.29.155, 45.90.30.15, 80.124.140.164, 130.59.31.251, 210.130.0.3, 45.90.29.207, 80.125.180.154, 54.246.187.60, 54.194.121.142, 194.50.94.140, 184.31.0.240, 185.255.55.25, 51.158.66.31, 45.90.28.159, 47.108.130.22, 45.90.28.7, 17.253.24.247, 86.106.90.57, 45.90.29.180, 95.211.44.91, 147.135.109.96, 45.90.30.173, 111.206.170.78, 199.38.182.47, 34.65.12.198, 193.191.129.45, 210.128.97.76, 103.247.37.150, 116.203.141.185, 194.191.40.86, 5.1.32.212, 45.90.30.141, 40.114.217.81, 210.130.0.1, 185.21.100.14, 191.209.16.235, 45.90.29.167, 193.191.129.41, 45.90.29.191, 45.90.29.105, 45.90.29.195, 185.235.81.3, 104.225.12.223, 45.90.30.8, 80.124.140.231, 82.165.167.96, 8.208.2.65, 45.90.29.125, 194.100.93.136, 83.69.169.69, 83.212.102.207, 45.90.29.7, 185.103.117.76, 31.216.14.41, 80.124.140.206, 149.112.121.30, 45.90.28.16, 192.109.42.42, 5.1.32.213, 54.69.221.253, 210.128.97.204, 17.253.26.119, 217.0.43.50, 192.73.252.11, 45.76.106.139, 107.174.206.189, 62.12.117.34, 61.148.33.140, 210.138.123.78, 160.119.253.209, 101.36.166.17, 202.232.2.31, 202.232.2.38, 210.128.97.222, 69.70.16.42 };

};

event connection_established(c: connection)
	{
	local service_port = c$id$resp_p;
	local doh_timeout: interval = 5 min ;
	#if ( c$orig$state == TCP_INACTIVE )
	#	{
	#	# We're seeing a half-established connection. Use the
	#	# service of the originator if it's well-known and the
	#	# responder isn't.
	#	if ( service_port !in likely_server_ports && c$id$orig_p in likely_server_ports )
	#		service_port = c$id$orig_p;
	#	}

	if ( service_port == 443/tcp and c$id$resp_h in doh_servers  )
		set_inactivity_timeout(c$id, doh_timeout);
	}